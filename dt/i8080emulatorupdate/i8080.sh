#!/bin/bash

echo 'Quick and dirty i8080 emulator by NASZVADI Peter, 2019, 2021.'
echo 'Press Ctrl+C to quit anytime!'

# 2KBASIC ROM from Oscar Toledo, converted to (memory)array
# https://nanochess.org/emulator.html
# https://ioccc.org/2006/toledo2/hint.text
# Memory initialization from address 0x0000
ROMFILENAME=${1:-2kbasic.rom}
if [[ -f "$ROMFILENAME" ]]
    then
    echo "Trying to load '$ROMFILENAME'"
    M=( $(  LC_ALL=C
            for((I=0;I<65536;I++)); do
            LC_ALL=C read -d $'\0' -r -n1
            printf -vCH %u "'$REPLY"
            echo $[(65536+CH)%256]
        done <$ROMFILENAME
    ) )
    echo "Loaded total ${#M[@]} bytes."
else
    M=()
fi

# MAGIC FLAG VALUES FOR ALL BYTE VALUES (S Z P)
P=(64   4   4   0   4   0   0   4   4   0   0   4   0   4   4   0
    4   0   0   4   0   4   4   0   0   4   4   0   4   0   0   4
    4   0   0   4   0   4   4   0   0   4   4   0   4   0   0   4
    0   4   4   0   4   0   0   4   4   0   0   4   0   4   4   0
    4   0   0   4   0   4   4   0   0   4   4   0   4   0   0   4
    0   4   4   0   4   0   0   4   4   0   0   4   0   4   4   0
    0   4   4   0   4   0   0   4   4   0   0   4   0   4   4   0
    4   0   0   4   0   4   4   0   0   4   4   0   4   0   0   4
  132 128 128 132 128 132 132 128 128 132 132 128 132 128 128 132
  128 132 132 128 132 128 128 132 132 128 128 132 128 132 132 128
  128 132 132 128 132 128 128 132 132 128 128 132 128 132 132 128
  132 128 128 132 128 132 132 128 128 132 132 128 132 128 128 132
  128 132 132 128 132 128 128 132 132 128 128 132 128 132 132 128
  132 128 128 132 128 132 132 128 128 132 132 128 132 128 128 132
  132 128 128 132 128 132 132 128 128 132 132 128 132 128 128 132
  128 132 132 128 132 128 128 132 132 128 128 132 128 132 132 128)

echo 'Initializing upper memory to NOPs'
for((;${#M[@]}<65536;M[${#M[@]}]+=0)){ :;}

echo 'Initializing register values'
((A=B=C=D=E=F=H=L=SP=PC=0))

echo 'Starting CPU emulation'
echo
for((;;)){
case $((M[PC++])) in
1)((C=M[PC++],B=M[PC++]));; # LXI B,nnnn
2)((M[(B<<8)|C]=A));; # STAX B
3)((C=C+1&255,B=!C+B&255));; # INX B
4)((B=B+1&255,F=(F&0x3B)|P[B]|(B&15?0:16)));; # INR B aux
5)((F=B&15?0:16,B=B+255&255,F=(F&0x3B)|P[B]));; # DCR B aux
6)((B=M[PC++]));; # MVI B,nn
7)((A=(A<<1)|(A>>7),F=(F&254)|(A&1)));; # RLC
9)((L+=C,H+=(L>>8)+B,F=(F&254)|(H>>8),H&=255,L&=255));; # DAD BC
10)((A=M[(B<<8)|C]));; # LDAX B
11)((C=C+255&255,B=(C==255?C:0)+B&255));; # DCX B
12)((C=C+1&255,F=(F&0x3B)|P[C]|(C&15?0:16)));; # INR C aux
13)((F=C&15?0:16,C=C+255&255,F=(F&0x3B)|P[C]));; # DCR C aux
14)((C=M[PC++]));; # MVI C,nn
15)((F=(F&254)|(A&1),A=(A>>1)|(A<<7)));; # RRC
17)((E=M[PC++],D=M[PC++]));; # LXI D,nnnn
18)((M[(D<<8)|E]=A));; # STAX D
19)((E=E+1&255,D=!E+D&255));; # INX D
20)((D=D+1&255,F=(F&0x3B)|P[D]|(D&15?0:16)));; # INR D aux
21)((F=D&15?0:16,D=D+255&255,F=(F&0x3B)|P[D]));; # DCR D aux
22)((D=M[PC++]));; # MVI D,nn
23)((A=(A<<1)|(F&1),F=(F&254)|(A>>8),A&=255));; # RAL
25)((L+=E,H+=(L>>8)+D,F=(F&254)|(H>>8),H&=255,L&=255));; # DAD D
26)((A=M[(D<<8)|E]));; # LDAX D
27)((E=E+255&255,D=(E==255?E:0)+D&255));; # DCX D
28)((E=E+1&255,F=(F&0x3B)|P[E]|(E&15?0:16)));; # INR E aux
29)((F=E&15?0:16,E=E+255&255,F=(F&0x3B)|P[E]));; # DCR E aux
30)((E=M[PC++]));; # MVI E,nn
31)((A|=F%2<<8,F=(F&254)|(A&1),A>>=1));; # RAR
33)((L=M[PC++],H=M[PC++]));; # LXI H,nnnn
34)((_Z=M[PC++]|(M[PC++]<<8),M[_Z++]=L,M[_Z&65535]=H));; # SHLD nnnn
35)((L=L+1&255,H=!L+H&255));; # INX H
36)((H=H+1&255,F=(F&0x3B)|P[H]|(H&15?0:16)));; # INR H aux
37)((F=H&15?0:16,H=H+255&255,F=(F&0x3B)|P[H]));; # DCR H aux
38)((H=M[PC++]));; # MVI H,nn
39)((_Z=A,_Z+=((F&16)|(A%16>9))?6:0,_Z+=((F&1)|(A>153))?96:0,F=(F&3)|(A&40)|(A>153?1:0)|((A^_Z)&16)|P[_Z],A=_Z ));; # DAA
41)((L+=L,H+=(L>>8)+H,F=(F&254)|(H>>8),H&=255,L&=255));; # DAD H
42)((_Z=M[PC++]|(M[PC++]<<8),L=M[_Z++],H=M[_Z&65535]));; # LHLD nnnn
43)((L=L+255&255,H=(L==255?L:0)+H&255));; # DCX H
44)((L=L+1&255,F=(F&0x3B)|P[L]|(L&15?0:16)));; # INR L aux
45)((F=L&15?0:16,L=L+255&255,F=(F&0x3B)|P[L]));; # DCR L aux
46)((L=M[PC++]));; # MVI L,nn
47)((A^=255));; # CMA
49)((SP=M[PC++]|(M[PC++]<<8)));; # LXI SP,nnnn
50)((M[M[PC++]|(M[PC++]<<8)]=A));; # STAX nnnn
51)((SP++));; # INX SP
52)((_Z=M[PC++]|(M[PC++]<<8),M[_Z]=M[_Z]+1&255,F=(F&0x3B)|P[M[_Z]]|(M[_Z]&15?0:16)));; # INR M aux
53)((_Z=M[PC++]|(M[PC++]<<8),F=M[_Z]&15?0:16,M[_Z]=M[_Z]+255&255,F=(F&0x3B)|P[M[_Z]]));; # DCR M aux
54)((M[L|(H<<8)]=M[PC++]));; # MVI M,nn
55)((F|=1));; # STC
57)((L+=SP&255,H+=SP+L>>8,F=(F&254)|(H>>8),H&=255,L&=255));; # DAD SP
58)((A=M[M[PC++]|(M[PC++]<<8)]));; # LDAX nnnn
59)((SP=SP+65535));; # DCX SP
60)((A=A+1&255,F=(F&0x3B)|P[A]|(A&15?0:16)));; # INR A aux
61)((F=L&15?0:16,A=A+255&255,F=(F&0x3B)|P[A]));; # DCR A aux
62)((A=M[PC++]));; # MVI A,nn
63)((F^=1));; # CMC

65)((B=C));;66)((B=D));;67)((B=E));;68)((B=H));;
69)((B=L));;70)((B=M[L|(H<<8)]));;71)((B=A));;
72)((C=B));;74)((C=D));;75)((C=E));;76)((C=H));;
77)((C=L));;78)((C=M[L|(H<<8)]));;79)((C=A));;

80)((D=B));;81)((D=C));;83)((D=E));;84)((D=H));;
85)((D=L));;86)((D=M[L|(H<<8)]));;87)((D=A));;
88)((E=B));;89)((E=C));;90)((E=D));;92)((E=H));;
93)((E=L));;94)((E=M[L|(H<<8)]));;95)((E=A));;

96)((H=B));;97)((H=C));;98)((H=D));;99)((H=E));;
101)((H=L));;102)((H=M[L|(H<<8)]));;103)((H=A));;
104)((L=B));;105)((L=C));;106)((L=D));;107)((L=E));;
108)((L=H));;110)((L=M[L|(H<<8)]));;111)((L=A));;

112)((M[L|(H<<8)]=B));;113)((M[L|(H<<8)]=C));;
114)((M[L|(H<<8)]=D));;115)((M[L|(H<<8)]=E));;
116)((M[L|(H<<8)]=H));;117)((M[L|(H<<8)]=L));;
118)((PC=PC+65535&65535));break ;;
119)((M[L|(H<<8)]=A));;

120)((A=B));;121)((A=C));;122)((A=D));;
123)((A=E));;124)((A=H));;125)((A=L));;
126)((A=M[L|(H<<8)]));;

128)((_Z=B,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
129)((_Z=C,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
130)((_Z=D,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
131)((_Z=E,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
132)((_Z=H,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
133)((_Z=L,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
135)((_Z=A,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
134)((_Z=M[L|(H<<8)],F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;

136)((_Z=B+F%2,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
137)((_Z=C+F%2,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
138)((_Z=D+F%2,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
139)((_Z=E+F%2,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
140)((_Z=H+F%2,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
141)((_Z=L+F%2,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
143)((_Z=A+F%2,          F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;
142)((_Z=M[L|(H<<8)]+F%2,F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));;

144)((_Z=B,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
145)((_Z=C,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
146)((_Z=D,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
147)((_Z=E,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
148)((_Z=H,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
149)((_Z=L,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
151)((_Z=A,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
150)((_Z=M[L|(H<<8)],F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;

152)((_Z=B+F%2,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
153)((_Z=C+F%2,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
154)((_Z=D+F%2,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
155)((_Z=E+F%2,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
156)((_Z=H+F%2,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
157)((_Z=L+F%2,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
159)((_Z=A+F%2,          F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;
158)((_Z=M[L|(H<<8)]+F%2,F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));;

160)((A&=B,F=P[A]));;     161)((A&=C,F=P[A]));;
162)((A&=D,F=P[A]));;     163)((A&=E,F=P[A]));;
164)((A&=H,F=P[A]));;     165)((A&=L,F=P[A]));;
166)((A&=M[L|(H<<8)],F=P[A]));;167)((F=P[A]));;

168)((A^=B,F=P[A]));;     169)((A^=C,F=P[A]));;
170)((A^=D,F=P[A]));;     171)((A^=E,F=P[A]));;
172)((A^=H,F=P[A]));;     173)((A^=L,F=P[A]));;
174)((A^=M[L|(H<<8)],F=P[A]));;175)((A=0,F=P[A]));;

176)((A|=B,F=P[A]));;     177)((A|=C,F=P[A]));;
178)((A|=D,F=P[A]));;     179)((A|=E,F=P[A]));;
180)((A|=H,F=P[A]));;     181)((A|=L,F=P[A]));;
182)((A|=M[L|(H<<8)],F=P[A]));;183)((F=P[A]));;

184)((_Z=B,          F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;
185)((_Z=C,          F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;
186)((_Z=D,          F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;
187)((_Z=E,          F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;
188)((_Z=H,          F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;
189)((_Z=L,          F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;
191)((_Z=A,          F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;
190)((_Z=M[L|(H<<8)],F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));;

193)((C=M[SP++&65535],B=M[SP++&65535]));; # POP B
197)((SP=SP+65535&65535,M[SP]=B,SP=SP+65535&65535,M[SP]=C));; # PUSH B
209)((E=M[SP++&65535],D=M[SP++&65535]));; # POP D
213)((SP=SP+65535&65535,M[SP]=D,SP=SP+65535&65535,M[SP]=E));; # PUSH D
225)((L=M[SP++&65535],H=M[SP++&65535]));; # POP H
229)((SP=SP+65535&65535,M[SP]=H,SP=SP+65535&65535,M[SP]=L));; # PUSH H
241)((F=M[SP++&65535],A=M[SP++&65535]));; # POP A
245)((SP=SP+65535&65535,M[SP]=A,SP=SP+65535&65535,M[SP]=F));; # PUSH A

# Various chaotic dirty ugly hekks, greetings to Pelikan A. et FIO guys :o)
211) ((PC++)); printf '\x'"$(printf %02x $A)";; # OUT nn
219) if ((M[PC++]==0))
     then A=0 # ((A=255))
     else IFS='' read -d '' -r -s -n 1 REPLY # >/dev/null 2>/dev/null
         printf -vA %u "'$REPLY"; ((A=(A==10)?13:(A+65536)%256))
     fi;; # IN nn

227)((_Z=L,L=M[SP],M[SP]=_Z,_Z=H,H=M[SP+1&65535],M[SP+1&65535]=_Z));; # XTHL
233)((PC=L|(H<<8)));; # PCHL
235)((_Z=L,L=E,E=_Z,_Z=H,H=D,D=_Z));; # XCHG
249)((SP=L|(H<<8)));; # SPHL

192)(( (F&64) || (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RNZ
200)(( (F&64) && (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RZ
201|217)((PC=M[SP++]|(M[SP++&65535]<<8)));; # RET
208)(( (F&1) || (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RNC
216)(( (F&1) && (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RC
224)(( (F&4) || (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RPO
232)(( (F&4) && (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RPE
240)(( (F&128) || (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RP
248)(( (F&128) && (PC=M[SP++]|(M[SP++&65535]<<8)) ));; # RM

194)((PC=PC+2&65535, (F&64) || (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JNZ nnnn
195|203)((PC=M[PC&65535]|(M[PC+1&65535]<<8)));; # JMP nnnn
202)((PC=PC+2&65535, (F&64) && (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JZ  nnnn
210)((PC=PC+2&65535, (F&1) || (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JNC nnnn
218)((PC=PC+2&65535, (F&1) && (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JC nnnn
226)((PC=PC+2&65535, (F&4) || (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JPO nnnn
234)((PC=PC+2&65535, (F&4) && (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JPE nnnn
242)((PC=PC+2&65535, (F&128) || (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JP nnnn
250)((PC=PC+2&65535, (F&128) && (PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8)) ));; # JM nnnn

#243) :;; # DI TODO
#251) :;; # EI TODO

196)((PC=PC+2&65535, (F&64) || (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CNZ nnnn
204)((PC=PC+2&65535, (F&64) && (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CZ  nnnn
205|221|237|253)((PC=PC+2&65535,M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534));; # CALL nnnn
212)((PC=PC+2&65535, (F&1) || (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CNC nnnn
220)((PC=PC+2&65535, (F&1) && (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CC nnnn
228)((PC=PC+2&65535, (F&4) || (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CPO nnnn
236)((PC=PC+2&65535, (F&4) && (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CPE nnnn
244)((PC=PC+2&65535, (F&128) || (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CP nnnn
252)((PC=PC+2&65535, (F&128) && (M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,PC=M[PC+65534&65535]|(M[PC+65535&65535]<<8),SP=SP+65534) ));; # CM nnnn

198)((_Z=M[PC++],F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));; # ADI nn
206)((_Z=M[PC++]+F%2,F=(A+_Z>>8)|((A%16+_Z%16)&16),A=A+_Z&255,F|=P[A]));; # ACI nn
214)((_Z=M[PC++],F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));; # SUI nn
222)((_Z=M[PC++]+F%2,F=(_Z>A)|((16+A%16-_Z%16)&16),A=A+512-_Z&255,F|=P[A]));; # SBI nn
230)((A&=M[PC++],F=P[A]));; # ANI nn
238)((A^=M[PC++],F=P[A]));; # XRI nn
246)((A|=M[PC++],F=P[A]));; # ORI nn
254)((_Z=M[PC++],F=(_Z>A)|((16+A%16-_Z%16)&16),F|=P[A+512-_Z&255]));; # CPI nn

199)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=0));; # RST 0
207)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=8));; # RST 1
215)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=16));; # RST 2
223)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=24));; # RST 3
231)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=32));; # RST 4
239)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=40));; # RST 5
247)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=48));; # RST 6
255)((M[SP+65535&65535]=PC>>8,M[SP+65534&65535]=PC&255,SP+=65534,PC=56));; # RST 7
esac
((PC&=65535,SP&=65535))
}
echo
echo 'HALTed the 8080 emulator'
echo 'Bye!'
